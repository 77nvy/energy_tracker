{% extends "base.html" %}
{% block content %}

<div class="page-content">
  <h1 class="page-title">{{ product["name"] }}</h1>
  <p class="ProductHeadline" style="font-size: 18px; margin-bottom: 32px;">{{ product["short_desc"] }}</p>

  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px; margin-bottom: 40px;">
    <div class="form-card">
      <h4>About</h4>
      <p style="color: var(--text-muted); line-height: 1.6;">{{ product["long_desc"] }}</p>

      <h4>Benefits</h4>
      <ul>
        {% for b in benefits %}
          <li>{{ b }}</li>
        {% endfor %}
      </ul>
    </div>

    <div class="form-card">
      <div class="card-header">Household Energy Use</div>

      <form id="energy-form" method="POST" action="{{ url_for('product', slug=product['slug']) }}">
        <!-- Helpful context to include in the email -->
        <input type="hidden" name="product_name" value="{{ product['name'] }}">
        <input type="hidden" name="product_slug" value="{{ product['slug'] }}">

        <div class="mb-2">
          <label class="form-label">Email (to receive results)</label>
          <input type="email" name="email" class="form-control" required>
          <input type="hidden" name="temp_password" id="temp_password">
        </div>

        <div class="mb-2">
          <label class="form-label">Electricity usage (kWh per month)</label>
          <input type="number" step="0.01" name="electricity_kwh" class="form-control" required>
        </div>

        <div class="mb-2">
          <label class="form-label">Gas usage (kWh per month)</label>
          <input type="number" step="0.01" name="gas_kwh" class="form-control" value="0">
        </div>

        <div class="mb-2">
          <label class="form-label">Home size</label>
          <select name="home_size" class="form-control">
            <option>Small</option>
            <option>Medium</option>
            <option>Large</option>
          </select>
        </div>

        <div class="mb-2">
          <label class="form-label">Number of occupants</label>
          <input type="number" name="occupants" min="1" value="1" class="form-control" required>
        </div>

        <div class="mb-2">
          <label class="form-label">EV charging at home?</label>
          <select name="ev_charging" class="form-control">
            <option value="no">No</option>
            <option value="yes">Yes</option>
          </select>
        </div>

        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" name="smart_home" id="smart_home">
          <label class="form-check-label" for="smart_home">Smart home devices?</label>
        </div>

        <button id="energy-submit" type="submit" class="btn btn-success w-100">
          Calculate Energy & Carbon Footprint
        </button>
      </form>
    </div>
  </div>
</div>


<script>
  emailjs.init({ publicKey: "OIOX6GNTOJ7FiHeWN" }); // your public key

  function makeTempPassword(length = 12) {
    // simple strong-ish demo password generator
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%";
    let out = "";
    for (let i = 0; i < length; i++) {
      out += chars[Math.floor(Math.random() * chars.length)];
    }
    return out;
  }

  window.addEventListener("load", () => {
    const form = document.getElementById("energy-form");
    if (!form) return;

    form.addEventListener("submit", (event) => {
      event.preventDefault();

      // Generate temp password and inject into form
      const pwd = makeTempPassword(12);
      document.getElementById("temp_password").value = pwd;

      // Add product name if you want it in the email
      // (or add <input type="hidden" name="product_name" value="{{product['name']}}"> in HTML)
      // For demo, we can set it dynamically if a hidden exists:
      const productHidden = form.querySelector('input[name="product_name"]');
      if (productHidden) productHidden.value = "{{ product['name'] }}";

      // Send email using EmailJS
      emailjs.sendForm("service_w1eelyk", "template_74m6f13", form)
        .then(() => {
          console.log("EmailJS SUCCESS");

          // After email is sent, submit to Flask to create account + store calc
          form.submit();
        })
        .catch((err) => {
          console.error("EmailJS FAILED:", err);
          alert("Email failed to send. Check console.");
        });
    });
  });
</script>
{% endblock %}
